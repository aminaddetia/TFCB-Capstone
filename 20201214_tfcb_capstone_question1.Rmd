---
title: "TFCB Capstone Question 1"
author: "Amin Addetia"
date: "12/15/2020"
output: html_document
---

# Impact of age and glaucoma status on candidate features used to develop a machine learning model for diagnosing glaucoma

The dataset analyzed here examines various features in individuals diagnosed with glaucoma compared to healthy individuals and then builds uses these data to build a machine learning model for diagnosing glaucoma. The model asssumes that each the of the factors are equally predictive regardless of the individual's age and uses the individual's age in the machine learning diagnosis decision tree. Here, I examine that underlying assumption by asking the following question: Are certain measured factors better predictors of glaucoma status for particular age groups or are all factors equally good predictors of glaucoma status regardless of an individual's age?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Loading the relevant libraries for the analysis.

library(tidyverse)
library(ggpubr)

```

## Reading in dataset and generating summary statistics for groups stratified by age and glaucoma status

This section reads in the [ds_whole.csv]('data/ds_whole.csv') file and outputs the summary file [age_group_glaucoma_summary_statistics.csv](age_group_glaucoma_summary_statistics.csv).

```{r cars}

#Reading in dataset

dataset <- read.csv('data/ds_whole.csv', header = T)

#Reassigning variables in glaucoma column to make more human readable

dataset %>%
  mutate(glaucoma=case_when(glaucoma == 0 ~ 'No',
                   glaucoma == 1 ~ 'Yes'), .keep = 'unused') -> dataset

#Adding a new column with age group for each observation, which is based on the age column

dataset %>% 
  mutate(age_group=case_when(age <= 20 ~ '20 yo and under',
                             age >= 21 & age <= 35 ~ '21-35 yo',
                             age >= 36 & age <= 50 ~ '36-50 yo',
                             age >= 51 & age <= 65 ~ '51-65 yo',
                             age >= 66 & age <= 80 ~ '66-80 yo',
                             age > 80 ~ '80 yo and over')) -> dataset

#Summarize the data based on glaucoma status and age group

dataset %>%
  group_by(age_group, glaucoma) %>%
  summarise_all(funs(mean)) -> summary

#Dropping the RL column

summary <- subset(summary, select = -c(RL))

#Renaming the column headers to make them more human-readable

summary %>%
  rename( 'Age Group'= age_group,
          Glaucoma = glaucoma,
          'Mean Age' = age,
          'Mean ocular pressure' = ocular_pressure,
          'Mean MD' = MD,
          'Mean PSD' = PSD,
          'Mean GHT' = GHT,
          'Mean cornea thickness' = cornea_thickness,
          'Mean RNFL thickness' = RNFL4.mean) -> summary

#Displaying the summary statistics

print(summary)

#Creating a csv file with the summary statistics

write.csv(summary, 'age_group_glaucoma_summary_statistics.csv', row.names = F)

```

## Plotting data stratified by age group and glaucoma.

This section takes the summary table generated in the chunk above and outputs plots for each of the candidate features in the [age_group_glaucoma_plots.png](age_group_glaucoma_plots.png) file.

```{r pressure, echo=FALSE}

#Creating individual boxplots for each of the variables, grouped by age group and glaucoma status.

MD_plot <- ggplot(dataset, aes(x=age_group, y=MD, fill=factor(glaucoma))) + geom_boxplot() + theme_classic() + xlab('Age Group') + labs(fill='Glaucoma') + theme(axis.text.x = element_text(angle = 90))
 
OP_plot <- ggplot(dataset, aes(x=age_group, y=ocular_pressure, fill=factor(glaucoma))) + geom_boxplot() + theme_classic() + xlab('Age Group') + labs(fill='Glaucoma') + ylab('Ocular Pressure') + theme(axis.text.x = element_text(angle = 90))
 
PSD_plot <- ggplot(dataset, aes(x=age_group, y=PSD, fill=factor(glaucoma))) + geom_boxplot() + theme_classic() + xlab('Age Group') + labs(fill='Glaucoma') + theme(axis.text.x = element_text(angle = 90))
 
GHT_plot <- ggplot(dataset, aes(x=age_group, y=GHT, fill=factor(glaucoma))) + geom_boxplot() + theme_classic() + xlab('Age Group') + labs(fill='Glaucoma') + theme(axis.text.x = element_text(angle = 90))

CT_plot <- ggplot(dataset, aes(x=age_group, y=cornea_thickness, fill=factor(glaucoma))) + geom_boxplot() + theme_classic() + xlab('Age Group') + labs(fill='Glaucoma') + ylab('Cornea Thickness') + theme(axis.text.x = element_text(angle = 90))

RNFL4_plot <- ggplot(dataset, aes(x=age_group, y=RNFL4.mean, fill=factor(glaucoma))) + geom_boxplot() + theme_classic() + xlab('Age Group') + labs(fill='Glaucoma') + ylab('RNFL Mean Thickness') + theme(axis.text.x = element_text(angle = 90))

#Arranging all the individual plots together in a single plot

plots <- ggarrange(MD_plot, OP_plot, PSD_plot, GHT_plot, CT_plot, RNFL4_plot, common.legend = T, legend = 'bottom') + theme(axis.text.x = element_text(angle = 90))

#Displaying the final plots

plot(plots)

#Saving the final plots as a png file

ggsave('age_group_glaucoma_plots.png', plot = plots)


```

To answer my research question, I visualized the data as boxplots stratified by age group and glaucoma status. I chose to use box plots for the plots as they display both the mean and range for the plotted dataset. As a result, they allow for an easy visual comparison of distributions between the glaucoma-positive and glaucoma-negative groups in each age group. I kept the coloring of glaucoma status identical in each plot for easy visual comparison across the plots.

The summary table and plots indicate that certain factors might be predictors of glaucoma status for particular age groups. For example, MD is likely a better predictor of glaucoma status for the 80 years old and over group than for other age groups. Further, ocular pressure is likely a better predictor of glaucoma status for younger individual than for older individuals. 

